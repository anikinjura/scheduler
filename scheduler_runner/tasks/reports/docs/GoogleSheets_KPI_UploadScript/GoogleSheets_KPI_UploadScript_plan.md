# План создания нового скрипта GoogleSheets_KPI_UploadScript.py

## Цель
Создать новый скрипт `GoogleSheets_KPI_UploadScript.py` с использованием новой архитектуры:
- Использование системы конфигураций `TableConfig`
- Использование новой утилиты для загрузки данных
- Поддержка новой системы валидации и обработки дубликатов

## Архитектура нового скрипта

### 1. Новая утилита для загрузки данных
- Файл: `scheduler_runner/tasks/reports/utils/load_reports_data.py`
- Назначение: универсальная загрузка данных отчетов с конфигурацией
- Функции: загрузка, объединение, форматирование данных отчетов

### 2. Новый скрипт
- Файл: `scheduler_runner/tasks/reports/GoogleSheets_KPI_UploadScript.py`
- Назначение: загрузка KPI данных в Google-таблицу
- Использует новую систему конфигураций

### 3. Новая конфигурация
- Файл: `scheduler_runner/tasks/reports/config/scripts/GoogleSheets_KPI_UploadScript_config.py`
- Назначение: конфигурация для нового скрипта
- Содержит: параметры подключения, структуру таблицы, параметры обработки

## Подробный план реализации

### Этап 1: Создание новой утилиты загрузки данных
**Файл:** `scheduler_runner/tasks/reports/utils/load_reports_data.py`

**Функции:**
- `load_reports_data(report_date: str, pvz_id: str, config: Dict) -> Dict[str, Any]`
- Универсальная загрузка данных отчетов
- Поддержка конфигурации типов отчетов
- Объединение данных по заданным правилам

**Структура:**
- Параметризированная загрузка отчетов
- Конфигурация шаблонов имен файлов
- Гибкая логика объединения данных

### Этап 2: Создание конфигурации для нового скрипта
**Файл:** `scheduler_runner/tasks/reports/config/scripts/GoogleSheets_KPI_UploadScript_config.py`

**Содержание:**
- Параметры подключения к Google Sheets
- Определение структуры таблицы через `TableConfig`
- Параметры обработки данных
- Параметры загрузки отчетов
- Расписание задачи

### Этап 3: Создание нового скрипта
**Файл:** `scheduler_runner/tasks/reports/GoogleSheets_KPI_UploadScript.py`

**Функции:**
- Загрузка данных отчетов через новую утилиту
- Форматирование данных под структуру таблицы
- Запись данных в Google-таблицу через утилиту `scheduler_runner/utils/google_sheets.py` 
- Обработка результатов и логирование

**Архитектура:**
```
GoogleSheets_KPI_UploadScript
├── load_reports_data (новая утилита)
├── GoogleSheetsReporter (API утилиты `scheduler_runner/utils/google_sheets.py`)
└── TableConfig (система конфигураций, поддерживаемая утилитой `scheduler_runner/utils/google_sheets.py`)
```

## Преимущества новой архитектуры

### 1. Унификация
- Единый подход к работе с Google Sheets
- Использование новой системы конфигураций
- Совместимость с новыми возможностями (batch-поиск, валидация и т.д.)

### 2. Гибкость
- Возможность легко изменять структуру таблицы
- Параметризированная обработка данных
- Настраиваемые правила объединения отчетов

### 3. Поддерживаемость
- Четкое разделение ответственности
- Упрощенное тестирование
- Легкость внесения изменений

## План миграции

### Этап 1: Создание новых компонентов
- Создать `load_reports_data.py`
- Создать `GoogleSheets_KPI_UploadScript_config.py`
- Создать `GoogleSheets_KPI_UploadScript.py`

### Этап 2: Тестирование новых компонентов
- Проверить загрузку данных
- Проверить запись в таблицу
- Проверить обработку дубликатов

### Этап 3: Постепенная миграция
- Запуск нового скрипта параллельно старому
- Сравнение результатов
- Постепенный переход на новый скрипт

## Сохранение старых компонентов
- `GoogleSheetsUploadScript.py` остается без изменений
- `reports_utils.py` остается без изменений
- `GoogleSheetsUploadScript_config.py` остается без изменений

## Требуемые зависимости
- `scheduler_runner.utils.google_sheets` (новая система)
- `TableConfig`, `ColumnDefinition`, `ColumnType`
- Существующие конфигурации и утилиты (для совместимости)