# Parser_KPI_Carriages_OzonScript - Документация

## Общее описание

Parser_KPI_Carriages_OzonScript - это скрипт для автоматического парсинга данных о перевозках (прямые и возвратные) из ERP-системы ОЗОН. Скрипт извлекает информацию о количестве перевозок и отправлений каждого типа за указанный период и сохраняет данные в формате, совместимом с системой отчетов.

## Архитектура

### Компоненты системы

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Parser_KPI_Carriages_OzonScript                  │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌──────────────────────────────────────────┐ │
│  │  Main Function  │  │        Configuration                     │ │
│  │                 │  │                                          │ │
│  │ parse_arguments │  │ ┌──────────────────────────────────────┐ │ │
│  │     main()      │  │ │ Parser_KPI_Carriages_OzonScript      │ │ │
│  │                 │  │ │              _config.py              │ │ │
│  └─────────────────┘  │ └──────────────────────────────────────┘ │ │
│                       │                                            │ │
│  ┌─────────────────┐  │ ┌──────────────────────────────────────┐ │ │
│  │   Parser        │  │ │         BaseOzonParser               │ │ │
│  │                 │  │ │                                      │ │ │
│  │ OzonCarriages   │  │ │    Базовый класс для парсинга       │ │ │
│  │ ReportParser    │  │ │         ОЗОН                         │ │ │
│  │                 │  │ └──────────────────────────────────────┘ │ │
│  └─────────────────┘  └──────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

### Зависимости

- `BaseOzonParser` - базовый класс для парсинга ОЗОН
- `Parser_KPI_Carriages_OzonScript_config.py` - конфигурационный файл
- `load_reports_data.py` - утилита для загрузки данных
- `data_transformers.py` - утилита для трансформации данных

## Структура

### Файлы компонентов

```
scheduler_runner/
├── tasks/
│   └── reports/
│       ├── Parser_KPI_Carriages_OzonScript.py          # Основной скрипт
│       ├── config/
│       │   └── scripts/
│       │       └── Parser_KPI_Carriages_OzonScript_config.py  # Конфигурация
│       └── tests/
│           └── test_parser_kpi_carriages_ozon_script.py # Тесты
└── docs/
    └── Parser_KPI_Carriages_OzonScript/
        ├── modification_plan.md                        # План модификации
        └── architecture_description.md                 # Архитектурное описание
```

### Структура скрипта

```python
Parser_KPI_Carriages_OzonScript.py
├── Imports
├── Constants
├── OzonCarriagesReportParser class
│   ├── __init__()
│   ├── login()
│   ├── navigate_to_reports()
│   ├── extract_data()
│   ├── process_flow_type()
│   ├── _extract_pvz_info()
│   ├── _extract_total_carriages()
│   ├── logout()
│   └── close()
├── parse_arguments()
├── main()
└── if __name__ == "__main__": main()
```

## Поток данных

### Графическое представление

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Пользователь  │───▶│   Аргументы      │───▶│   Конфигурация  │
│   (дата, логи)  │    │   командной      │    │   (шаблоны URL, │
└─────────────────┘    │   строки)        │    │   селекторы)    │
                       └──────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        │
┌─────────────────┐    ┌──────────────────┐             │
│   Браузер       │◀───│   Формирование   │─────────────┘
│   (ОЗОН)        │    │   URL по шаблону │
└─────────────────┘    │   из конфига     │
                       └──────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Парсер        │───▶│   Извлечение     │───▶│   Форматирование│
│   (Selenium)    │    │   данных         │    │   данных        │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Файл отчета   │◀───│   Сохранение     │    │   Сохранение    │
│   (JSON)        │    │   данных         │    │   данных        │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### Последовательность операций

1. Пользователь запускает скрипт с аргументами (дата, логи)
2. Скрипт загружает конфигурацию (шаблоны URL, селекторы, параметры)
3. На основе аргументов и шаблонов из конфигурации формируется URL с фильтрацией по дате и типу перевозок
4. Создается экземпляр парсера с обновленной конфигурацией
5. Открывается браузер и переходит на сформированный URL для прямых перевозок
6. Извлекаются данные о прямых перевозках (номера, количество отправлений)
7. Переход на URL для возвратных перевозок
8. Извлекаются данные о возвратных перевозках (номера, количество отправлений)
9. Данные объединяются и форматируются в JSON-файл

## Входные данные

### Аргументы командной строки

- `--detailed_logs` - включить детализированные логи
- `--date` - дата для парсинга в формате YYYY-MM-DD (по умолчанию - сегодня)

### Примеры запуска

```bash
# Запуск с текущей датой
python Parser_KPI_Carriages_OzonScript.py --detailed_logs

# Запуск с указанной датой
python Parser_KPI_Carriages_OzonScript.py --date 2026-01-06 --detailed_logs
```

## Что делает скрипт

### Основные функции

1. **Парсинг аргументов** - обработка командной строки
2. **Настройка логирования** - инициализация системы логирования
3. **Создание экземпляра парсера** - инициализация класса OzonCarriagesReportParser
4. **Настройка драйвера** - запуск браузера с нужными параметрами
5. **Логин в систему** - переход на страницу ОЗОН
6. **Навигация к отчету** - переход к странице отчета о перевозках
7. **Извлечение данных для прямых перевозок** - получение информации о прямых перевозках
8. **Извлечение данных для возвратных перевозок** - получение информации о возвратных перевозках
9. **Объединение данных** - объединение данных о прямых и возвратных перевозках
10. **Сохранение данных** - запись в JSON-файл
11. **Завершение работы** - закрытие браузера

### Вызовы других компонентов

- `BaseOzonParser.setup_driver()` - настройка Selenium драйвера
- `BaseOzonParser.extract_ozon_data_by_pattern()` - извлечение данных по паттерну
- `BaseOzonParser.extract_ozon_element_by_xpath()` - извлечение данных по XPath
- `configure_logger()` - настройка логирования

## Выходные данные

### Формат JSON-файла

```json
{
  "marketplace": "Ozon",
  "report_type": "carriages_combined",
  "date": "2026-01-06",
  "timestamp": "2026-01-07T18:27:34.857114",
  "page_title": "Система управления заказами ПВЗ",
  "current_url": "https://turbo-pvz.ozon.ru/outbound/carriages-archive?filter=%7B%22startSentMoment%22:%222026-01-06T00:00:00%2B03:00%22,%22endSentMoment%22:%222026-01-06T23:59:59%2B03:00%22%7D",
  "direct_flow": {
    "flow_type": "Direct",
    "total_carriages_found": 2,
    "carriage_numbers": [
      "092999844",
      "092991926"
    ],
    "carriage_details": [
      {
        "carriage_number": "092999844",
        "items_count": 1
      },
      {
        "carriage_number": "092991926",
        "items_count": 10
      }
    ],
    "total_items_count": 11
  },
  "return_flow": {
    "flow_type": "Return",
    "total_carriages_found": 1,
    "carriage_numbers": [
      "092986689"
    ],
    "carriage_details": [
      {
        "carriage_number": "092986689",
        "items_count": 46
      }
    ],
    "total_items_count": 46
  },
  "pvz_info": "СОСНОВКА_10",
  "raw_data": {
    "page_source_length": 483667,
    "page_text_length": 627
  }
}
```

### Поля отчета

- `marketplace` - маркетплейс (всегда "Ozon")
- `report_type` - тип отчета ("carriages_combined")
- `date` - дата отчета
- `timestamp` - время создания отчета
- `page_title` - заголовок страницы
- `current_url` - текущий URL с фильтрацией
- `direct_flow` - данные о прямых перевозках
  - `flow_type` - тип перевозок ("Direct")
  - `total_carriages_found` - общее количество найденных перевозок
  - `carriage_numbers` - массив номеров перевозок
  - `carriage_details` - детали по каждой перевозке
  - `total_items_count` - общее количество отправлений
- `return_flow` - данные о возвратных перевозках (структура аналогична direct_flow)
- `pvz_info` - информация о пункте выдачи
- `raw_data` - техническая информация о странице

## Сохранение отчета

### Путь к файлу

Файлы сохраняются в директории:
```
reports/json/ozon_carriages_report_{pvz}_{date}.json
```

### Пример имени файла

```
reports/json/ozon_carriages_report_SOSNOVKA_10_20260106.json
```

## Интеграция с системой

### Совместимость

- Совместим с системой `load_reports_data` через `REPORT_CONFIGS`
- Совместим с `GoogleSheetsTransformer` для преобразования данных
- Совместим с системой уведомлений через `Telegram_KPI_NotificationScript`
- Совместим с планировщиком задач через `TASK_SCHEDULE`

### Конфигурация интеграции

```python
REPORT_CONFIGS = [
    ReportConfig(
        report_type='carriages',
        file_pattern='ozon_carriages_report_{pvz_id}_{date}.json',
        required=False,
        fields_mapping={
            'total_carriages': 'total_carriages',
            'direct_flow_count': 'direct_flow_count',
            'return_flow_count': 'return_flow_count',
            'pvz_info': 'pvz_info',
            'marketplace': 'marketplace'
        }
    )
]
```

### Зависимости между компонентами

#### 1. Parser_KPI_Carriages_OzonScript.py зависит от:
- `BaseOzonParser` - базовый класс для парсинга ОЗОН
- `SCRIPT_CONFIG` из конфигурационного файла
- `ERP_URL_TEMPLATE`, `DATE_FORMAT`, `FLOW_TYPE_FILTER_TEMPLATE` из конфигурации для формирования URL
- Утилиты `configure_logger` для логирования
- Утилиты `load_reports_data` для сохранения данных
- Утилиты `data_transformers` для преобразования данных

#### 2. Parser_KPI_Carriages_OzonScript_config.py зависит от:
- `config.base_config.PVZ_ID` - глобальный идентификатор ПВЗ
- `scheduler_runner.tasks.reports.config.reports_paths.REPORTS_PATHS` - пути к отчетам
- `ReportConfig` из `load_reports_data` - для конфигурации отчетов
- `TableConfig` из `google_sheets` - для структуры таблицы

#### 3. Компоненты системы, зависящие от нового скрипта:
- Система планировщика задач (использует `TASK_SCHEDULE`)
- Утилита `load_reports_data` (через `REPORT_CONFIGS`)
- Система уведомлений (через формат данных)
- Google Sheets интеграция (через формат данных и `TableConfig`)

#### 4. Взаимодействие между компонентами:
```
Веб-страница ОЗОН → Parser_KPI_Carriages_OzonScript →
→ формирование URL по шаблону из конфигурации →
→ извлеченные данные → data_transformers →
→ унифицированный формат → load_reports_data →
→ сохранение в JSON → другие компоненты системы
```

#### 5. Порядок инициализации:
1. Конфигурация (`Parser_KPI_Carriages_OzonScript_config.py`)
2. Формирование URL по шаблону из конфигурации
3. Парсер (`Parser_KPI_Carriages_OzonScript.py`)
4. Универсальные утилиты (`load_reports_data`, `data_transformers`)
5. Система логирования
6. Сохранение результатов

## Тестирование

### Типы тестов

- `test_parse_arguments_defaults()` - тест парсинга аргументов по умолчанию
- `test_parse_arguments_with_values()` - тест парсинга с переданными значениями
- `test_extract_data_success()` - тест успешного извлечения данных
- `test_extract_data_with_mocked_selenium()` - тест с моканным Selenium
- `test_main_function_with_mocked_dependencies()` - тест основной функции с моками
- `test_data_transformation()` - тест трансформации данных
- `test_error_handling()` - тест обработки ошибок
- `test_config_integration()` - тест интеграции с конфигурацией

## Особенности реализации

### Двухэтапный парсинг

Скрипт реализует двухэтапный процесс:
- Сначала извлекаются данные о прямых перевозках (Direct)
- Затем извлекаются данные о возвратных перевозках (Return)
- Результаты объединяются в один отчет

### Детальный парсинг

Для каждой перевозки извлекается:
- Номер перевозки
- Количество отправлений в перевозке
- Дополнительные детали (при наличии)

### Формирование URL

URL формируется с правильной фильтрацией по дате и типу перевозок с использованием шаблонов из конфигурации:
- `ERP_URL_TEMPLATE` - шаблон полного URL
- `DATE_FILTER_TEMPLATE` - шаблон фильтра по дате
- `FLOW_TYPE_FILTER_TEMPLATE` - шаблон фильтра по типу перевозок
- `DATE_FORMAT` - формат даты для подстановки в шаблоны

Пример формирования URL:
```
https://turbo-pvz.ozon.ru/outbound/carriages-archive?filter=%7B%22startSentMoment%22:%222026-01-06T00:00:00%2B03:00%22,%22endSentMoment%22:%222026-01-06T23:59:59%2B03:00%22,%22flowType%22:%22Direct%22%7D
```

### Централизованная конфигурация

Все параметры формирования URL определены в конфигурационном файле:
- Нет хардкода в скрипте
- При изменении формата URL в ERP достаточно обновить шаблоны в конфигурации
- Гибкость и поддерживаемость системы

### Обработка ошибок

Скрипт включает обработку различных исключений Selenium и других ошибок, обеспечивая стабильную работу даже при проблемах с доступом к странице.