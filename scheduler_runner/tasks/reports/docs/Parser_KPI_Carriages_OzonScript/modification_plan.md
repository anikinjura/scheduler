# План модификации скрипта Parser_KPI_Carriages_OzonScript.py

## 1. Анализ текущего состояния

### 1.1. Структура текущего скрипта
- Скрипт `Parser_KPI_Carriages_OzonScript.py` создан как копия `Parser_KPI_Giveout_OzonScript.py`
- Использует базовый класс `BaseOzonParser`
- Имеет простую структуру данных: `total_carriages`, `direct_flow_count`, `return_flow_count`
- Использует централизованную конфигурацию с шаблонами URL

### 1.2. Анализ старого скрипта OzonCarriagesReportScript.py
- Реализует **двухэтапный парсинг**: прямые и возвратные перевозки
- Использует **разные URL** для каждого типа перевозок
- Извлекает **детальную информацию**: номера перевозок, количество отправлений
- Для каждой перевозки **переходит на отдельную страницу** для получения деталей
- Имеет **сложную структуру данных** с вложенными объектами

## 2. Цели модификации

### 2.1. Основные цели
- **Адаптировать** новый скрипт под логику старого скрипта
- **Сохранить** архитектурные преимущества нового скрипта (изоляция, централизованная конфигурация)
- **Реализовать** двухэтапный парсинг для прямых и возвратных перевозок
- **Добавить** детальный парсинг каждой перевозки

### 2.2. Технические требования
- Поддержка **разных URL** для фильтрации по типу перевозок
- **Детальный парсинг** номеров перевозок и количества отправлений
- **Обработка** каждой перевозки отдельно с возвратом на основную страницу
- **Объединение** результатов в один отчет

## 3. Подробный план модификации

### 3.1. Модификация конфигурационного файла

#### 3.1.1. Обновление URL структуры
- Заменить текущий `BASE_URL` на `https://turbo-pvz.ozon.ru/outbound/carriages-archive`
- Обновить `DATE_FILTER_TEMPLATE` с форматом `?filter=%7B%22startSentMoment%22:%22{date}T00:00:00%2B03:00%22,%22endSentMoment%22:%22{date}T23:59:59%2B03:00%22`
- Добавить `FLOW_TYPE_FILTER_TEMPLATE` = `,%22flowType%22:%22{flow_type}%22`
- Создать шаблоны `DIRECT_FLOW_URL_TEMPLATE` и `RETURN_FLOW_URL_TEMPLATE` с использованием `FLOW_TYPE_FILTER_TEMPLATE`
- Обновить `ERP_URL_TEMPLATE` для использования нового формата фильтрации
- Обновить `DATE_FORMAT` на `"%Y-%m-%d"` для совместимости с новым форматом

#### 3.1.2. Обновление селекторов
- Обновить `TOTAL_CARRIAGES` для поиска элемента с "Найдено: N"
- Добавить `CARRIAGE_NUMBER` для извлечения номеров перевозок
- Добавить `TOTAL_ITEMS_ON_DETAIL_PAGE` для извлечения количества отправлений на странице деталей

#### 3.1.3. Обновление структуры данных
- Заменить текущую `REPORT_DATA_SCHEMA` на структуру с вложенными объектами для прямых и возвратных перевозок

### 3.2. Модификация основного скрипта

#### 3.2.1. Обновление метода `extract_data`
- Добавить параметр `flow_type` для указания типа перевозок
- Реализовать логику извлечения номеров перевозок
- Реализовать обработку каждой перевозки отдельно
- Добавить переход на страницу деталей для получения количества отправлений

#### 3.2.2. Добавление метода `process_flow_type`
- Реализовать метод для обработки одного типа перевозок
- Извлечение общего количества перевозок
- Извлечение номеров перевозок
- Обработка каждой перевозки с получением деталей

#### 3.2.3. Обновление основной функции `main`
- Реализовать двухэтапный процесс: сначала прямые, затем возвратные перевозки
- Объединение результатов в один отчет
- Обновление логики сохранения данных

### 3.3. Система шаблонов URL

#### 3.3.1. Принцип работы
- Использовать систему шаблонов, аналогичную текущей реализации
- `ERP_URL_TEMPLATE` формируется из `BASE_URL` и `DATE_FILTER_TEMPLATE`
- `DIRECT_FLOW_URL_TEMPLATE` и `RETURN_FLOW_URL_TEMPLATE` формируются из `BASE_URL`, `DATE_FILTER_TEMPLATE` и `FLOW_TYPE_FILTER_TEMPLATE`
- При запуске скрипта шаблоны используются для формирования конкретных URL с подстановкой даты и типа перевозок

#### 3.3.2. Динамическое формирование URL
- В функции `main` формируются конкретные URL для прямых и возвратных перевозок на основе шаблонов
- Подстановка даты происходит в соответствии с аргументом командной строки
- Подстановка типа перевозок происходит в зависимости от этапа обработки

### 3.4. Обновление структуры отчета

#### 3.4.1. Новая структура данных
```
{
  'marketplace': 'Ozon',
  'report_type': 'carriages_combined',
  'date': '{date}',
  'timestamp': '{timestamp}',
  'page_title': '{page_title}',
  'current_url': '{current_url}',
  'direct_flow': {
    'flow_type': 'Direct',
    'total_carriages_found': '{total_direct_carriages}',
    'carriage_numbers': ['{carriage_numbers_array}'],
    'carriage_details': [
      {
        'carriage_number': '{number}',
        'items_count': '{items_count}',
        'error': '{error}'  // опционально
      }
    ],
    'total_items_count': '{total_direct_items}'
  },
  'return_flow': {
    'flow_type': 'Return',
    'total_carriages_found': '{total_return_carriages}',
    'carriage_numbers': ['{carriage_numbers_array}'],
    'carriage_details': [
      {
        'carriage_number': '{number}',
        'items_count': '{items_count}',
        'error': '{error}'  // опционально
      }
    ],
    'total_items_count': '{total_return_items}'
  },
  'pvz_info': '{pvz_info}',
  'raw_data': {
    'page_source_length': '{page_source_length}',
    'page_text_length': '{page_text_length}'
  }
}
```

## 4. Этапы реализации

### Этап 1: Подготовка конфигурации
- [ ] Обновить URL структуру в конфигурационном файле
- [ ] Обновить селекторы
- [ ] Обновить структуру данных REPORT_DATA_SCHEMA

### Этап 2: Модификация основного скрипта
- [ ] Обновить метод `extract_data` для работы с типом перевозок
- [ ] Реализовать метод `process_flow_type`
- [ ] Добавить вспомогательные методы для детального парсинга

### Этап 3: Обновление основной логики
- [ ] Обновить функцию `main` для двухэтапного парсинга
- [ ] Реализовать объединение результатов
- [ ] Обновить логику сохранения

### Этап 4: Тестирование и проверка
- [ ] Обновить тесты для нового функционала
- [ ] Проверить корректность извлечения данных
- [ ] Проверить обработку ошибок

## 5. Ссылки на реализацию в источнике OzonCarriagesReportScript.py

### 5.1. Методы для изучения
- **`process_flow_type`** (строки ~300-400) - основная логика обработки одного типа перевозок
- **`extract_data`** (строки ~80-200) - извлечение данных с учетом типа перевозок
- **`_extract_pvz_info`** (строки ~240-280) - извлечение информации о ПВЗ
- **`_try_set_pvz`** (строки ~210-240) - установка правильного ПВЗ

### 5.2. Конфигурация URL
- **Константы URL** (строки ~20-30) - `BASE_URL`, `DATE_FILTER`, `DIRECT_FLOW_FILTER`, `RETURN_FLOW_FILTER`
- **Готовые URL** (строки ~32-37) - `ERP_URL`, `DIRECT_FLOW_URL`, `RETURN_FLOW_URL`

### 5.3. Селекторы
- **`SELECTORS`** (строки ~45-55) - селекторы для элементов страницы
- Особое внимание: `TOTAL_CARRIAGES`, `CARRIAGE_NUMBER`, `TOTAL_ITEMS_ON_DETAIL_PAGE`

### 5.4. Структура данных
- **Возврат из `extract_data`** (строки ~170-190) - структура возвращаемых данных
- **Объединение данных** в функции `main` (строки ~500-530) - объединение прямых и возвратных перевозок

### 5.5. Логика основной функции
- **Двухэтапный процесс** в `main` (строки ~470-520) - сначала прямые, затем возвратные перевозки
- **Обработка ошибок** и возврат на основную страницу после обработки каждой перевозки

### 5.6. Использование существующих методов из Parser_KPI_Carriages_OzonScript.py
- **`_extract_pvz_info`** - использовать без изменений (уже реализован)
- **`_try_set_pvz`** - использовать без изменений (уже реализован)
- **`_check_authorization_status`** - использовать без изменений (уже реализован)
- **`_substitute_values_in_schema`** - использовать без изменений (уже реализован)
- **`extract_data`** - требует расширения для поддержки типа перевозок и детального парсинга
- **`_extract_total_carriages`** - требует корректировки для работы с "Найдено: N" форматом
- **`_extract_direct_flow_count`** и **`_extract_return_flow_count`** - заменить на более универсальные методы
- **`main`** - требует корректировки для двухэтапного процесса и объединения результатов

### 5.7. Использование методов из базового класса BaseOzonParser
- **`extract_ozon_element_by_xpath`** - использовать для извлечения элементов по XPath (уже используется в `_extract_pvz_info`)
- **`extract_ozon_data_by_pattern`** - использовать для извлечения данных по регулярным выражениям
- **`select_pvz_dropdown_option`** - использовать для выбора ПВЗ (уже используется в `_try_set_pvz`)
- **`setup_driver`** - использовать для настройки драйвера (уже используется в `main`)
- **`close`** - использовать для закрытия драйвера (уже используется в `main`)

### 5.8. Модификация существующих методов
- **`extract_data`** (строки ~80-200 в OzonCarriagesReportScript.py) - адаптировать текущую реализацию, добавить параметр `flow_type`, реализовать детальный парсинг
- **`_extract_total_carriages`** - обновить для извлечения "Найдено: N" вместо общего количества (использовать регулярное выражение `FOUND_PATTERN` из строки ~20 в OzonCarriagesReportScript.py)
- **`_extract_direct_flow_count`** и **`_extract_return_flow_count`** - заменить на методы, извлекающие номера перевозок и обрабатывающие каждую перевозку отдельно
- **`main`** - добавить двухэтапный процесс и объединение результатов (использовать логику из строк ~470-520 в OzonCarriagesReportScript.py)
- **Добавить метод `process_flow_type`** (аналогично строкам ~300-400 в OzonCarriagesReportScript.py) - основная логика обработки одного типа перевозок

### 5.9. Унификация обработки ошибок
- Использовать унифицированный подход к обработке ошибок, аналогичный реализации в `extract_data` (строки ~150-200 в OzonCarriagesReportScript.py)
- Обеспечить возврат на основную страницу после обработки каждой перевозки при возникновении ошибки
- Использовать ту же структуру возвращаемых данных об ошибках, что и в текущей реализации

## 6. Архитектурные соображения

### 6.1. Сохранение принципов изоляции
- Скрипт должен оставаться **изолированным**
- Не должен зависеть от других компонентов системы
- Все зависимости должны быть явно определены в конфигурации

### 6.2. Совместимость с архитектурой
- Сохранить **централизованную конфигурацию** с шаблонами URL
- Сохранить **универсальную структуру данных** с подстановкой значений
- Сохранить **единообразие** с другими аналогичными скриптами системы (scheduler_runner\tasks\reports\Parser_KPI_Giveout_OzonScript.py)

### 6.3. Гибкость и поддерживаемость
- Обеспечить **легкость изменения** форматов URL и селекторов
- Обеспечить **понятную структуру** для будущих модификаций
- Обеспечить **четкое разделение** ответственности между методами