# Parser_KPI_Giveout_OzonScript - Документация

## Общее описание

Parser_KPI_Giveout_OzonScript - это скрипт для автоматического парсинга данных о выдачах из ERP-системы ОЗОН. Скрипт извлекает информацию о количестве выданных посылок за указанный период и сохраняет данные в формате, совместимом с системой отчетов.

## Архитектура

### Компоненты системы

```
┌─────────────────────────────────────────────────────────────┐
│                    Parser_KPI_Giveout_OzonScript            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌──────────────────────────────────┐ │
│  │  Main Function  │  │        Configuration             │ │
│  │                 │  │                                  │ │
│  │ parse_arguments │  │ ┌──────────────────────────────┐ │ │
│  │     main()      │  │ │ Parser_KPI_Giveout_OzonScript│ │ │
│  │                 │  │ │        _config.py            │ │ │
│  └─────────────────┘  │ └──────────────────────────────┘ │ │
│                       │                                  │ │
│  ┌─────────────────┐  │ ┌──────────────────────────────┐ │ │
│  │   Parser        │  │ │         BaseOzonParser       │ │ │
│  │                 │  │ │                              │ │ │
│  │ OzonGiveout     │  │ │    Базовый класс для парсинга│ │ │
│  │ ReportParser    │  │ │         ОЗОН                 │ │ │
│  │                 │  │ └──────────────────────────────┘ │ │
│  └─────────────────┘  └──────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### Зависимости

- `BaseOzonParser` - базовый класс для парсинга ОЗОН
- `Parser_KPI_Giveout_OzonScript_config.py` - конфигурационный файл
- `load_reports_data.py` - утилита для загрузки данных
- `data_transformers.py` - утилита для трансформации данных

## Структура

### Файлы компонентов

```
scheduler_runner/
├── tasks/
│   └── reports/
│       ├── Parser_KPI_Giveout_OzonScript.py          # Основной скрипт
│       ├── config/
│       │   └── scripts/
│       │       └── Parser_KPI_Giveout_OzonScript_config.py  # Конфигурация
│       └── tests/
│           └── test_parser_kpi_giveout_ozon_script.py # Тесты
└── docs/
    └── Parser_KPI_Giveout_OzonScript/
        ├── Parser_KPI_Giveout_OzonScript_plan.md      # План разработки
        ├── detailed_implementation_plan.md            # Подробный план
        └── updated_implementation_plan.md             # Обновленный план
```

### Структура скрипта

```python
Parser_KPI_Giveout_OzonScript.py
├── Imports
├── Constants
├── OzonGiveoutReportParser class
│   ├── __init__()
│   ├── login()
│   ├── navigate_to_reports()
│   ├── extract_data()
│   ├── _extract_pvz_info()
│   ├── _extract_total_giveout()
│   ├── _extract_issued_packages()
│   ├── logout()
│   └── close()
├── parse_arguments()
├── main()
└── if __name__ == "__main__": main()
```

## Поток данных

### Графическое представление

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Пользователь  │───▶│   Аргументы      │───▶│   Конфигурация  │
│   (дата, логи)  │    │   командной      │    │   (шаблоны URL, │
└─────────────────┘    │   строки)        │    │   селекторы)    │
                       └──────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        │
┌─────────────────┐    ┌──────────────────┐             │
│   Браузер       │◀───│   Формирование   │─────────────┘
│   (ОЗОН)        │    │   URL по шаблону │
└─────────────────┘    │   из конфига     │
                       └──────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Парсер        │───▶│   Извлечение     │───▶│   Форматирование│
│   (Selenium)    │    │   данных         │    │   данных        │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Файл отчета   │◀───│   Сохранение     │    │   Сохранение    │
│   (JSON)        │    │   данных         │    │   данных        │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### Последовательность операций

1. Пользователь запускает скрипт с аргументами (дата, логи)
2. Скрипт загружает конфигурацию (шаблоны URL, селекторы, параметры)
3. На основе аргументов и шаблонов из конфигурации формируется URL с фильтрацией по дате
4. Создается экземпляр парсера с обновленной конфигурацией
5. Открывается браузер и переходит на сформированный URL
6. Извлекаются данные о выдачах (включая "Всего: N")
7. Данные форматируются и сохраняются в JSON-файл

## Входные данные

### Аргументы командной строки

- `--detailed_logs` - включить детализированные логи
- `--date` - дата для парсинга в формате YYYY-MM-DD (по умолчанию - сегодня)

### Примеры запуска

```bash
# Запуск с текущей датой
python Parser_KPI_Giveout_OzonScript.py --detailed_logs

# Запуск с указанной датой
python Parser_KPI_Giveout_OzonScript.py --date 2026-01-06 --detailed_logs
```

## Что делает скрипт

### Основные функции

1. **Парсинг аргументов** - обработка командной строки
2. **Настройка логирования** - инициализация системы логирования
3. **Создание экземпляра парсера** - инициализация класса OzonGiveoutReportParser
4. **Настройка драйвера** - запуск браузера с нужными параметрами
5. **Логин в систему** - переход на страницу ОЗОН
6. **Навигация к отчету** - переход к странице отчета о выдачах
7. **Извлечение данных** - извлечение информации о выдачах
8. **Сохранение данных** - запись в JSON-файл
9. **Завершение работы** - закрытие браузера

### Вызовы других компонентов

- `BaseOzonParser.setup_driver()` - настройка Selenium драйвера
- `BaseOzonParser.extract_ozon_data_by_pattern()` - извлечение данных по паттерну
- `BaseOzonParser.extract_ozon_element_by_xpath()` - извлечение данных по XPath
- `configure_logger()` - настройка логирования

## Выходные данные

### Формат JSON-файла

```json
{
  "marketplace": "Ozon",
  "report_type": "giveout",
  "date": "2026-01-06",
  "timestamp": "2026-01-07T01:58:19.568428",
  "page_title": "Система управления заказами ПВЗ",
  "current_url": "https://turbo-pvz.ozon.ru/reports/giveout?filter={%22startDate%22:%222026-01-06%22,%22endDate%22:%222026-01-06%22}",
  "issued_packages": 257,
  "total_packages": 0,
  "pvz_info": "СОСНОВКА_10",
  "raw_data": {
    "page_source_length": 732740,
    "page_text_length": 5183
  }
}
```

### Поля отчета

- `marketplace` - маркетплейс (всегда "Ozon")
- `report_type` - тип отчета ("giveout")
- `date` - дата отчета
- `timestamp` - время создания отчета
- `page_title` - заголовок страницы
- `current_url` - текущий URL с фильтрацией
- `issued_packages` - количество выданных посылок (главная цифра "Всего: N")
- `total_packages` - общее количество (всегда 0 в текущей реализации)
- `pvz_info` - информация о пункте выдачи
- `raw_data` - техническая информация о странице

## Сохранение отчета

### Путь к файлу

Файлы сохраняются в директории:
```
reports/json/ozon_giveout_report_{pvz}_{date}.json
```

### Пример имени файла

```
reports/json/ozon_giveout_report_SOSNOVKA_10_20260106.json
```

## Интеграция с системой

### Совместимость

- Совместим с системой `load_reports_data` через `REPORT_CONFIGS`
- Совместим с `GoogleSheetsTransformer` для преобразования данных
- Совместим с системой уведомлений через `Telegram_KPI_NotificationScript`
- Совместим с планировщиком задач через `TASK_SCHEDULE`

### Конфигурация интеграции

```python
REPORT_CONFIGS = [
    ReportConfig(
        report_type='giveout',
        file_pattern='ozon_giveout_report_{pvz_id}_{date}.json',
        required=False,
        fields_mapping={
            'issued_packages': 'issued_packages',
            'total_packages': 'total_packages',
            'pvz_info': 'pvz_info',
            'marketplace': 'marketplace'
        }
    )
]
```

### Зависимости между компонентами

#### 1. Parser_KPI_Giveout_OzonScript.py зависит от:
- `BaseOzonParser` - базовый класс для парсинга ОЗОН
- `SCRIPT_CONFIG` из конфигурационного файла
- `ERP_URL_TEMPLATE`, `DATE_FORMAT` из конфигурации для формирования URL
- Утилиты `configure_logger` для логирования
- Утилиты `load_reports_data` для сохранения данных
- Утилиты `data_transformers` для преобразования данных

#### 2. Parser_KPI_Giveout_OzonScript_config.py зависит от:
- `config.base_config.PVZ_ID` - глобальный идентификатор ПВЗ
- `scheduler_runner.tasks.reports.config.reports_paths.REPORTS_PATHS` - пути к отчетам
- `ReportConfig` из `load_reports_data` - для конфигурации отчетов
- `TableConfig` из `google_sheets` - для структуры таблицы

#### 3. Компоненты системы, зависящие от нового скрипта:
- Система планировщика задач (использует `TASK_SCHEDULE`)
- Утилита `load_reports_data` (через `REPORT_CONFIGS`)
- Система уведомлений (через формат данных)
- Google Sheets интеграция (через формат данных и `TableConfig`)

#### 4. Взаимодействие между компонентами:
```
Веб-страница ОЗОН → Parser_KPI_Giveout_OzonScript →
→ формирование URL по шаблону из конфигурации →
→ извлеченные данные → data_transformers →
→ унифицированный формат → load_reports_data →
→ сохранение в JSON → другие компоненты системы
```

#### 5. Порядок инициализации:
1. Конфигурация (`Parser_KPI_Giveout_OzonScript_config.py`)
2. Формирование URL по шаблону из конфигурации
3. Парсер (`Parser_KPI_Giveout_OzonScript.py`)
4. Универсальные утилиты (`load_reports_data`, `data_transformers`)
5. Система логирования
6. Сохранение результатов

## Тестирование

### Типы тестов

- `test_parse_arguments_defaults()` - тест парсинга аргументов по умолчанию
- `test_parse_arguments_with_values()` - тест парсинга с переданными значениями
- `test_extract_data_success()` - тест успешного извлечения данных
- `test_extract_data_with_mocked_selenium()` - тест с моканным Selenium
- `test_main_function_with_mocked_dependencies()` - тест основной функции с моками
- `test_data_transformation()` - тест трансформации данных
- `test_error_handling()` - тест обработки ошибок
- `test_config_integration()` - тест интеграции с конфигурацией
- `test_config_report_configs()` - тест конфигурации REPORT_CONFIGS

## Особенности реализации

### Извлечение главной цифры

Скрипт использует регулярное выражение `r'Всего:\s*(\d+)'` для поиска фразы "Всего: N" на странице, что соответствует основной цифре отчета.

### Формирование URL

URL формируется с правильной фильтрацией по дате с использованием шаблонов из конфигурации:
- `ERP_URL_TEMPLATE` - шаблон полного URL
- `DATE_FILTER_TEMPLATE` - шаблон фильтра по дате
- `DATE_FORMAT` - формат даты для подстановки в шаблоны

Пример формирования URL:
```
https://turbo-pvz.ozon.ru/reports/giveout?filter={%22startDate%22:%222026-01-06%22,%22endDate%22:%222026-01-06%22}
```

### Централизованная конфигурация

Все параметры формирования URL определены в конфигурационном файле:
- Нет хардкода в скрипте
- При изменении формата URL в ERP достаточно обновить шаблоны в конфигурации
- Гибкость и поддерживаемость системы

### Обработка ошибок

Скрипт включает обработку различных исключений Selenium и других ошибок, обеспечивая стабильную работу даже при проблемах с доступом к странице.