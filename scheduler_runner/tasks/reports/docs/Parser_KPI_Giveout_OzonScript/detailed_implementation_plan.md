# Подробный поэтапный план реализации Parser_KPI_Giveout_OzonScript

## Этап 1: Подготовка и анализ архитектуры (1 день)

### 1.1. Изучение базовых классов и утилит
- [x] Изучить `BaseOzonParser.py` - базовый класс для парсинга ОЗОН
- [x] Изучить `BaseParser.py` - общий базовый класс для парсинга
- [x] Изучить `scheduler_runner/tasks/reports/config/reports_base_config.py` - базовые классы конфигураций
- [x] Изучить `scheduler_runner/tasks/reports/utils/load_reports_data.py` - универсальная утилита загрузки данных
- [x] Изучить `scheduler_runner/tasks/reports/utils/data_transformers.py` - утилита для трансформации данных

### 1.2. Изучение примеров архитектуры
- [x] Изучить `Telegram_KPI_NotificationScript.py` и его конфигурацию
- [x] Изучить `GoogleSheets_KPI_UploadScript.py` и его конфигурацию
- [x] Изучить `OzonCarriagesReportScript.py` и его улучшения

### 1.3. Анализ структуры конфигураций
- [x] Изучить `scheduler_runner/tasks/reports/config/scripts/` - примеры конфигураций
- [x] Понять структуру `ReportConfig` и `TableConfig`

## Этап 2: Создание конфигурации скрипта (1 день)

### 2.1. Создание файла конфигурации
- [x] Создать `scheduler_runner/tasks/reports/config/scripts/Parser_KPI_Giveout_OzonScript_config.py`
- [x] Определить импорты: `ReportConfig`, `TableConfig`, пути и базовые конфигурации
- [x] Определить константы и селекторы для парсинга ОЗОН

### 2.2. Определение структуры REPORT_CONFIGS
- [x] Создать `REPORT_CONFIGS` с использованием `ReportConfig`
- [x] Определить `TableConfig` для совместимости с Google Sheets
- [x] Настроить `SCRIPT_CONFIG` с основными параметрами
- [x] Определить `TASK_SCHEDULE` для планировщика задач

## Этап 3: Создание основного скрипта (2-3 дня)

### 3.1. Создание структуры скрипта
- [x] Создать `scheduler_runner/tasks/reports/Parser_KPI_Giveout_OzonScript.py`
- [x] Определить импорты: базовые классы, утилиты, конфигурации
- [x] Определить модульные константы (улучшенная практика из OzonCarriagesReportScript)

### 3.2. Реализация класса парсера
- [x] Создать класс, наследующийся от `BaseOzonParser`
- [x] Реализовать методы: `login()`, `navigate_to_reports()`, `extract_data()`, `logout()`
- [x] Добавить улучшенную обработку ошибок (TimeoutException, NoSuchElementException)

### 3.3. Реализация вспомогательных функций
- [x] Создать функции обработки и трансформации данных
- [x] Реализовать `parse_arguments()` для CLI
- [x] Реализовать `main()` функцию с логикой скрипта

## Этап 4: Интеграция с системой (1 день)

### 4.1. Интеграция с load_reports_data
- [x] Обеспечить совместимость с универсальной утилитой загрузки данных
- [x] Протестировать загрузку данных через `REPORT_CONFIGS`

### 4.2. Интеграция с трансформерами данных
- [x] Использовать `GoogleSheetsTransformer` для преобразования данных
- [x] Обеспечить совместимость с форматом Google Sheets

## Этап 5: Тестирование (2-3 дня)

### 5.1. Создание юнит-тестов
- [x] Создать `scheduler_runner/tasks/reports/tests/test_parser_kpi_giveout_ozon_script.py`
- [x] Написать тесты для парсинга аргументов
- [x] Написать тесты для загрузки данных
- [x] Написать тесты для основной логики с моками
- [x] Написать тесты для обработки ошибок

### 5.2. Тестирование интеграции
- [x] Протестировать интеграцию с конфигурацией
- [x] Протестировать совместимость с системой уведомлений
- [x] Протестировать совместимость с Google Sheets

## Этап 6: Документирование и финальная проверка (1 день)

### 6.1. Документирование кода
- [x] Добавить docstrings ко всем основным функциям и классам
- [x] Обновить README файлы при необходимости

### 6.2. Финальная проверка
- [x] Проверить соответствие унифицированной архитектуре
- [x] Проверить обработку ошибок
- [x] Проверить логирование
- [x] Проверить совместимость с планировщиком задач

## Подробное описание задач для каждого этапа

### Этап 2: Создание конфигурации скрипта

#### 2.1.1. Создание файла конфигурации
- Создать файл `scheduler_runner/tasks/reports/config/scripts/Parser_KPI_Giveout_OzonScript_config.py`
- Добавить стандартный заголовок с описанием и автором
- Импортировать необходимые модули:
  - `config.base_config.PVZ_ID`
  - `scheduler_runner.tasks.reports.config.reports_paths.REPORTS_PATHS`
  - `scheduler_runner.utils.google_sheets.TableConfig, ColumnType, ColumnDefinition`
  - `scheduler_runner.tasks.reports.utils.load_reports_data.ReportConfig`

#### 2.1.2. Определение констант и селекторов
- Определить `MODULE_PATH` для скрипта
- Определить селекторы для элементов на странице ОЗОН:
  - `SELECTORS = { "PVZ_INPUT": "...", "TOTAL_GIVEOUT": "...", "GIVEOUT_ITEMS": "..." }`
- Определить константы для магических строк (как в OzonCarriagesReportScript)

#### 2.2.1. Создание REPORT_CONFIGS
- Создать список `REPORT_CONFIGS` с одним `ReportConfig` для отчета о выдачах
- Установить `report_type='giveout'`
- Установить соответствующий `file_pattern`
- Определить `fields_mapping` для отображения полей

#### 2.2.2. Настройка SCRIPT_CONFIG
- Определить все необходимые параметры: `ERP_URL`, `OUTPUT_DIR`, `USER`, `TASK_NAME`, и т.д.
- Установить `HEADLESS` режим
- Установить таймауты и другие параметры

#### 2.2.3. Определение TASK_SCHEDULE
- Создать расписание задачи с указанием времени запуска
- Убедиться, что время соответствует логике обновления данных

### Этап 3: Создание основного скрипта

#### 3.1.1. Создание структуры скрипта
- Создать файл `scheduler_runner/tasks/reports/Parser_KPI_Giveout_OzonScript.py`
- Добавить стандартный заголовок с описанием
- Импортировать все необходимые модули и классы
- Определить модульные константы (как в OzonCarriagesReportScript)

#### 3.2.1. Реализация класса парсера
- Создать класс `OzonGiveoutReportParser`, наследующийся от `BaseOzonParser`
- Реализовать метод `login()` - вход в систему
- Реализовать метод `navigate_to_reports()` - навигация к отчету о выдачах
- Реализовать метод `extract_data()` - извлечение данных о выдачах
- Реализовать метод `logout()` - выход из системы

#### 3.2.2. Добавление улучшенной обработки ошибок
- Использовать `TimeoutException`, `NoSuchElementException` из Selenium
- Добавить детализированное логирование
- Обработать различные сценарии ошибок

#### 3.3.1. Реализация вспомогательных функций
- Создать функцию `parse_arguments()` с аргументами командной строки
- Создать функцию `main()` с основной логикой скрипта
- Обеспечить корректную обработку исключений

### Этап 4: Интеграция с системой

#### 4.1.1. Совместимость с load_reports_data
- Убедиться, что формат данных соответствует ожидаемому
- Протестировать загрузку через универсальную утилиту
- Проверить маппинг полей

#### 4.2.1. Интеграция с трансформерами
- Использовать `GoogleSheetsTransformer` для преобразования данных
- Убедиться, что формат совместим с Google Sheets
- Проверить корректность трансформации

### Этап 5: Тестирование

#### 5.1.1. Создание юнит-тестов
- Создать файл `scheduler_runner/tasks/reports/tests/test_parser_kpi_giveout_ozon_script.py`
- Написать тесты для всех основных функций
- Использовать `unittest.mock` для изоляции компонентов
- Покрыть тестами различные сценарии использования

## Зависимости между этапами

- Этап 2 (конфигурация) должен быть завершен перед началом Этапа 3 (основной скрипт)
- Этап 1 (анализ) должен быть завершен перед началом Этапа 2 и Этапа 3
- Этапы 4-6 могут частично выполняться параллельно с Этапами 2-3 при условии заглушек

## Оценка трудозатрат

- Этап 1: 1 день (анализ существующего кода)
- Этап 2: 1 день (создание конфигурации)
- Этап 3: 2-3 дня (реализация основного скрипта)
- Этап 4: 1 день (интеграция)
- Этап 5: 2-3 дня (тестирование)
- Этап 6: 1 день (документирование и проверка)

Общая оценка: 8-11 дней

## Выявленные аспекты и уточнения

### 1. Разделение ответственности
В процессе реализации было принято важное решение о разделении ответственности:
- Скрипт `Parser_KPI_Giveout_OzonScript.py` отвечает **только** за парсинг данных и сохранение их в формате, совместимом с системой
- Функции форматирования для уведомлений и другие дополнительные функции **не должны** быть включены в основной скрипт
- Эти функции должны быть реализованы в соответствующих модулях (например, в системе уведомлений или загрузки в Google Sheets)

### 2. Совместимость с существующей архитектурой
- Скрипт успешно интегрирован с системой `load_reports_data` через `REPORT_CONFIGS`
- Формат данных совместим с `GoogleSheetsTransformer`
- Скрипт соответствует унифицированной архитектуре проекта

### 3. Особенности тестирования
- Были выявлены и исправлены проблемы с тестами, связанные с различиями в структуре конфигурации
- Тесты были адаптированы для корректной проверки моков
- Добавлены тесты для проверки совместимости с системой загрузки данных

### 4. Структура данных
- Скрипт сохраняет данные в формате JSON с полями: `marketplace`, `report_type`, `date`, `timestamp`, `issued_packages`, `total_packages`, `pvz_info` и др.
- Формат данных соответствует ожидаемому для последующей обработки другими компонентами системы