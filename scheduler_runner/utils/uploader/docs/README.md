# Изолированный микросервис загрузчика данных

## Общее описание

Микросервис загрузчика данных представляет собой изолированную систему, которая принимает все специфичные параметры извне и возвращает результат загрузки данных. Архитектура спроектирована таким образом, чтобы микросервис не содержал жестко закодированных значений, зависимостей от внешних конфигураций или специфичных настроек, привязанных к конкретной реализации.

## Структура документации

### 1. [Интерфейс взаимодействия](Interface.md)
- `upload_data()` - загрузка одиночного набора данных
- `upload_batch_data()` - пакетная загрузка данных
- `test_connection()` - проверка подключения к системе загрузки
- Стратегии загрузки - управление дубликатами через сопоставление уникальных ключей

### 2. [Базовые классы](CoreClasses.md)
- `BaseUploader` - базовый класс для загрузки данных
- `BaseReportUploader` - абстрактный класс для загрузки отчетов

### 3. [Реализации](Implementations/GoogleSheetsUploader.md)
- `GoogleSheetsUploader` - реализация для загрузки в Google Sheets

### 4. [Компоненты провайдеров](Providers/GoogleSheets/Components.md)
- `providers/google_sheets/` - компоненты для Google Sheets:
  - `GoogleSheetsReporter` - основной класс для работы с Google Sheets
  - `TableConfig`, `ColumnDefinition`, `ColumnType` - структуры данных для конфигурации таблиц
  - Механизм сопоставления уникальных ключей - избежание дубликатов при загрузке

## Параметры, принимаемые извне

### 1. Параметры подключения
- `CREDENTIALS_PATH` - путь к файлу учетных данных Google API
- `SPREADSHEET_ID` - ID электронной таблицы Google Sheets
- `WORKSHEET_NAME` - имя листа в таблице
- `TABLE_CONFIG` - конфигурация структуры таблицы

### 2. Данные для загрузки
- Словарь с данными для загрузки
- Может содержать любую структуру, соответствующую конфигурации таблицы

### 3. Внешний логгер
- Готовый объект логгера для использования в микросервисе
- Позволяет интегрировать логирование в общую систему

### 4. Дополнительные параметры (опционально)
- `UPLOAD_STRATEGY` - стратегия загрузки (update_or_append, append_only, update_only)
- `TABLE_CONFIG` - конфигурация структуры таблицы, включая уникальные ключи
- Другие параметры, специфичные для конкретной задачи

### 5. Стратегии загрузки
- `update_or_append` (по умолчанию) - обновляет строку, если найдена по уникальным ключам, иначе добавляет новую
- `append_only` - всегда добавляет новую строку, не проверяя наличие существующих
- `update_only` - обновляет строку, если найдена по уникальным ключам, иначе пропускает

## Использование микросервиса

### 1. Простая загрузка данных
```python
from scheduler_runner.utils.uploader import upload_data

connection_params = {
    "CREDENTIALS_PATH": "path/to/credentials.json",
    "SPREADSHEET_ID": "your_spreadsheet_id",
    "WORKSHEET_NAME": "Sheet1",
    "TABLE_CONFIG": your_table_config_object
}

data = {
    "Дата": "2023-01-01",
    "ПВЗ": "Москва",
    "Количество выдач": 100
}

result = upload_data(
    data=data,
    connection_params=connection_params
)
```

### 2. Пакетная загрузка данных
```python
data_list = [
    {"Дата": "2023-01-01", "ПВЗ": "Москва", "Количество выдач": 100},
    {"Дата": "2023-01-02", "ПВЗ": "Москва", "Количество выдач": 120}
]

result = upload_batch_data(
    data_list=data_list,
    connection_params=connection_params
)
```

### 3. Загрузка с внешним логгером
```python
from scheduler_runner.utils.logging import configure_logger

logger = configure_logger(user="system", task_name="UploadTask")

result = upload_data(
    data=data,
    connection_params=connection_params,
    logger=logger
)
```

### 4. Проверка подключения
```python
from scheduler_runner.utils.uploader import test_connection

result = test_connection(connection_params)
if result["success"]:
    print("Подключение успешно")
else:
    print("Ошибка подключения")
```

### 5. Работа с уникальными ключами
Микросервис поддерживает стратегию `update_or_append`, которая позволяет избежать дубликатов при загрузке данных:

```python
# Указываем стратегию обновления/добавления
result = upload_data(
    data=data,
    connection_params=connection_params,
    strategy="update_or_append"  # или "append_only", "update_only"
)

# Стратегия update_or_append:
# 1. Сначала ищет существующие строки по уникальным ключам (из TABLE_CONFIG)
# 2. Если строка с такими же уникальными ключами найдена - обновляет её
# 3. Если строка не найдена - добавляет новую
```

### 6. Примеры использования различных стратегий
```python
# Стратегия update_or_append - обновить или добавить
result = upload_data(
    data=data,
    connection_params=connection_params,
    strategy="update_or_append"
)

# Стратегия append_only - всегда добавлять новую строку
result = upload_data(
    data=data,
    connection_params=connection_params,
    strategy="append_only"
)

# Стратегия update_only - обновить только если строка найдена
result = upload_data(
    data=data,
    connection_params=connection_params,
    strategy="update_only"
)
```

## Преимущества архитектуры

1. **Полная изоляция** - микросервис не содержит специфичных параметров
2. **Гибкость** - поддержка различных стратегий загрузки и форматов данных
3. **Интеграция** - возможность передачи внешнего логгера
4. **Расширяемость** - легко добавлять новые способы загрузки данных
5. **Безопасность** - все чувствительные параметры передаются извне
6. **Тестируемость** - возможность тестирования подключения отдельно
7. **Управление дубликатами** - поддержка сопоставления уникальных ключей для избежания дубликатов

## Использование в центральном процессоре домена

Центральный процессор домена может использовать микросервис следующим образом:
1. Подготовить параметры подключения
2. Подготовить данные для загрузки (сырые или трансформированные)
3. Передать готовый логгер для интеграции с общей системой логирования
4. Выбрать стратегию загрузки (update_or_append, append_only, update_only)
5. Вызвать `upload_data()` или `upload_batch_data()` для загрузки данных
6. Обработать результат загрузки

При использовании стратегии `update_or_append` микросервис автоматически:
- Ищет существующие строки по уникальным ключам (определены в TABLE_CONFIG)
- Нормализует значения (включая даты) для корректного сопоставления
- Обновляет существующую строку, если найдена, или добавляет новую

Такая архитектура позволяет использовать микросервис в различных контекстах без изменений внутренней логики.