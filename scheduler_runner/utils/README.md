# Утилиты ядра планировщика

В этой директории собраны утилиты, используемые ядром планировщика (`runner.py`) и задачами для выполнения низкоуровневых операций.

---

## `filesystem.py`

Предоставляет функции для работы с файловой системой.

- **`remove_old_files(target_folder, days_threshold, logger)`**: Удаляет файлы в `target_folder`, которые старше `days_threshold` дней.
- **`remove_empty_folders(target_folder, logger)`**: Рекурсивно удаляет пустые папки в `target_folder`.
- **`copy_recent_files(src, dst, days_threshold, conflict_mode, logger)`**: Копирует файлы из `src` в `dst`, которые были изменены за последние `days_threshold` дней. Обрабатывает конфликты (`skip` или `rename`).
- **`ensure_directory_exists(path, logger)`**: Создаёт директорию, если она не существует.
- **`FileSystemUtils.validate_readable_path(path)`**: Проверяет, существует ли путь и доступен ли для чтения.
- **`FileSystemUtils.validate_writable_path(path)`**: Проверяет, существует ли путь и доступен ли для записи.

---

## `logging.py`

Модуль для настройки и управления логированием.

- **`configure_logger(user, task_name, detailed, ...)`**: Конфигурирует и возвращает логгер.
  - Создает структуру логов `logs/<user>/<task_name>/YYYY-MM-DD.log`.
  - Поддерживает ротацию лог-файлов.
  - При `detailed=True` создает отдельный лог-файл с уровнем `DEBUG`.
  - Автоматически очищает старые логи.

---

## `notify.py`

Утилита для отправки уведомлений.

- **`send_telegram_message(token, chat_id, message, logger)`**: Отправляет сообщение через Telegram API.

---

## `schedule_utils.py`

Утилита для автоматического сбора расписаний задач.

- **`collect_task_schedule(domain)`**: Сканирует директорию `tasks/<domain>/config/scripts/`, импортирует все `*_config.py` файлы и собирает из них переменные `SCHEDULE` в единый список.

---

## `subprocess.py`

Модуль для безопасного запуска подпроцессов.

- **`run_subprocess(script_name, args, env, logger, ...)`**: Запускает Python-модуль как подпроцесс.
  - **Защита от двойного запуска**: Использует lock-файл (`.lock`) для предотвращения одновременного выполнения одной и той же задачи.
  - **Идемпотентность**: Использует файл `.last_run` для отслеживания последнего запуска в определенном "окне" времени (например, в течение одного часа для `hourly` задач), чтобы избежать повторного выполнения.
  - **Таймаут**: Контролирует максимальное время выполнения процесса.
  - **"Fire-and-forget"**: С помощью параметра `no_timeout_control=True` может запустить процесс и не дожидаться его завершения, снимая контроль таймаута.
  - **Логирование**: Захватывает и логирует `stdout` и `stderr` подпроцесса.

---

## `system.py`

Системные утилиты.

- **`SystemUtils.shutdown_computer(logger)`**: Выключает компьютер, используя соответствующую команду для текущей ОС (Windows, Linux, macOS).

---

## `timing.py`

Модуль для проверки времени запуска задач.

- **`should_run_now(task, now)`**: Определяет, должна ли задача выполняться в текущий момент времени.
  - **`hourly`**: Задача запускается всегда.
  - **`daily`**: Задача запускается, если текущий час совпадает с часом, указанным в расписании (например, если `now.hour == 14` и в расписании `14:30`, задача будет запущена).
  - **`once`**: Зарезервировано для будущих реализаций.
